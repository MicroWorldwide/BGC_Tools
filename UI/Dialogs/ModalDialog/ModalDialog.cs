using System;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.UI;

namespace BGC.UI.Dialogs
{
    public class ModalDialog : MonoBehaviour
    {
        [Header("Dialog Buttons")]
        [SerializeField]
        private Button buttonA = null;
        [SerializeField]
        private Button buttonB = null;
        [SerializeField]
        private Button buttonC = null;

        [Header("Dialog Components")]
        [SerializeField]
        private Text headerText = null;
        [SerializeField]
        private Text primaryBodyText = null;
        [SerializeField]
        private InputField primaryInputField = null;
        [SerializeField]
        private Dropdown optionDropdown = null;
        [SerializeField]
        private Text secondaryBodyText = null;
        [SerializeField]
        private InputField secondaryInputField = null;

        private static ModalDialog instance;

        public enum Response
        {
            A = 0,
            Confirm = A,
            Yes = A,

            B,
            Cancel = B,
            No = B,

            C,
            Accept = C
        }

        public enum Mode
        {
            ConfirmCancel = 0,
            Accept,
            YesNo,
            InputConfirmCancel,
            InputAccept,
            LockDown,
            ABC,
            InputInputConfirmCancel,
            DropdownInput
        }

        public delegate void ModalButtonCallback(Response response);
        ModalButtonCallback buttonCallback;

        public delegate void ModalInputCallback(Response response, string inputText);
        ModalInputCallback inputCallback;

        public delegate void ModalDoubleInputCallback(Response response, string primaryInput, string secondaryInput);
        ModalDoubleInputCallback doubleInputCallback;

        public delegate void ModalDropdownInputCallback(Response response, int selectionIndex, string secondaryInput);
        ModalDropdownInputCallback dropdownInputCallback;

        public ModalDialog()
        {
            instance = this;
        }

        public void Initialize()
        {
            instance = this;
        }

        private void Awake()
        {
            buttonA.onClick.AddListener(() => HandleButtons(Response.A));
            buttonB.onClick.AddListener(() => HandleButtons(Response.B));
            buttonC.onClick.AddListener(() => HandleButtons(Response.C));
        }

        private void SetHeaderText(string text)
        {
            headerText.text = text;
        }

        private void SetBodyText(string primaryText, string secondaryText = "")
        {
            primaryBodyText.text = primaryText;
            secondaryBodyText.text = secondaryText;
        }

        private void SetMode(Mode mode)
        {
            primaryInputField.text = "";
            primaryInputField.gameObject.SetActive(
                mode == Mode.InputAccept ||
                mode == Mode.InputConfirmCancel ||
                mode == Mode.InputInputConfirmCancel);

            secondaryBodyText.gameObject.SetActive(mode == Mode.InputInputConfirmCancel || mode == Mode.DropdownInput);

            secondaryInputField.text = "";
            secondaryInputField.gameObject.SetActive(mode == Mode.InputInputConfirmCancel || mode == Mode.DropdownInput);

            optionDropdown.gameObject.SetActive(mode == Mode.DropdownInput);

            //Set button text
            switch (mode)
            {
                case Mode.ConfirmCancel:
                case Mode.InputConfirmCancel:
                case Mode.InputInputConfirmCancel:
                case Mode.DropdownInput:
                    SetButtonText(a: "Confirm", b: "Cancel");
                    break;

                case Mode.YesNo:
                    SetButtonText(a: "Yes", b: "No");
                    break;

                case Mode.Accept:
                case Mode.InputAccept:
                    SetButtonText(c: "Ok");
                    break;

                case Mode.ABC:
                    //Do nothing - Text set separately
                    break;

                case Mode.LockDown:
                    //Clear & Lock all buttons
                    SetButtonText(a: "", b: "", c: "");
                    break;

                default:
                    Debug.LogError($"Unexpected DialogMode: {mode}");
                    break;
            }

        }

        private void SetButtonText(string a = "", string b = "", string c = "")
        {
            buttonA.gameObject.SetActive(string.IsNullOrEmpty(a) == false);
            buttonB.gameObject.SetActive(string.IsNullOrEmpty(b) == false);
            buttonC.gameObject.SetActive(string.IsNullOrEmpty(c) == false);

            buttonA.GetComponentInChildren<Text>().text = a;
            buttonB.GetComponentInChildren<Text>().text = b;
            buttonC.GetComponentInChildren<Text>().text = c;
        }

        /// <summary>
        /// Show the modal dialog in the indicated mode, and call the callback when it receives a response
        /// </summary>
        public static void ShowSimpleModal(
            Mode mode,
            string headerText,
            string bodyText,
            ModalButtonCallback callback = null)
        {
            Debug.Assert(
                condition: mode != Mode.InputAccept && mode != Mode.InputConfirmCancel,
                message: "Incorrect method call.  Call ShowInputModal instead.");

            Debug.Assert(
                condition: mode != Mode.InputInputConfirmCancel,
                message: "Incorrect method call.  Call ShowInputModal instead.");


            //Update text
            instance.SetHeaderText(headerText);
            instance.SetBodyText(bodyText);

            //Update buttons
            instance.SetMode(mode);

            //Set dialog visible
            instance.gameObject.SetActive(true);

            //Update Callbacks
            instance.buttonCallback = callback;
            instance.inputCallback = null;
            instance.doubleInputCallback = null;
            instance.dropdownInputCallback = null;
        }

        /// <summary>
        /// Show the modal dialog in the indicated mode, and call the callback when it receives a response
        /// </summary>
        public static void ShowCustomSimpleModal(
            string headerText,
            string bodyText,
            string buttonALabel,
            string buttonBLabel,
            string buttonCLabel,
            ModalButtonCallback callback)
        {
            //Update Text
            instance.SetHeaderText(headerText);
            instance.SetBodyText(bodyText);

            //Update buttons
            instance.SetMode(Mode.ABC);
            instance.SetButtonText(buttonALabel, buttonBLabel, buttonCLabel);

            //Set dialog visible
            instance.gameObject.SetActive(true);

            //Update Callbacks
            instance.buttonCallback = callback;
            instance.inputCallback = null;
            instance.doubleInputCallback = null;
            instance.dropdownInputCallback = null;
        }

        /// <summary>
        /// Show the modal dialog in the indicated mode, and call the callback when it receives a response
        /// </summary>
        public static void ShowInputModal(
            Mode mode,
            string headerText,
            string bodyText,
            ModalInputCallback inputCallback,
            ModalButtonCallback buttonCallback = null,
            InputField.ContentType inputType = InputField.ContentType.Alphanumeric)
        {
            Debug.Assert(
                condition: mode == Mode.InputAccept || mode == Mode.InputConfirmCancel,
                message: "Incorrect method call.  Don't call ShowInputModal if not using input.");

            //Update text
            instance.SetHeaderText(headerText);
            instance.SetBodyText(bodyText);

            //Update buttons
            instance.SetMode(mode);

            //Set dialog visible
            instance.gameObject.SetActive(true);

            //Update callbacks
            instance.buttonCallback = buttonCallback;
            instance.inputCallback = inputCallback;
            instance.doubleInputCallback = null;
            instance.dropdownInputCallback = null;

            instance.primaryInputField.contentType = inputType;
        }

        /// <summary>
        /// Show the modal dialog in the indicated mode, and call the callback when it receives a response
        /// </summary>
        public static void ShowInputModal(
            string headerText,
            string primaryBodyText,
            string secondaryBodyText,
            ModalDoubleInputCallback inputCallback,
            ModalButtonCallback buttonCallback = null,
            InputField.ContentType primaryInputType = InputField.ContentType.Alphanumeric,
            InputField.ContentType secondaryInputType = InputField.ContentType.Alphanumeric)
        {
            //Update text
            instance.SetHeaderText(headerText);
            instance.SetBodyText(primaryBodyText, secondaryBodyText);

            //Update buttons
            instance.SetMode(Mode.InputInputConfirmCancel);

            //Set dialog visible
            instance.gameObject.SetActive(true);

            //Update callbacks
            instance.buttonCallback = buttonCallback;
            instance.inputCallback = null;
            instance.doubleInputCallback = inputCallback;
            instance.dropdownInputCallback = null;

            instance.primaryInputField.contentType = primaryInputType;
            instance.secondaryInputField.contentType = secondaryInputType;
        }

        /// <summary>
        /// Accept the button repsonse as input, invoke and clear the callbacks, and hide the dialog
        /// </summary>
        private void HandleButtons(Response response)
        {
            //Temporary copy to allow for the calling of the dialog within a callback
            ModalButtonCallback tmpCallback = buttonCallback;
            ModalInputCallback tmpInputCallback = inputCallback;
            ModalDoubleInputCallback tmpDoubleInputCallback = doubleInputCallback;
            ModalDropdownInputCallback tmpDropdownInputCallback = dropdownInputCallback;

            buttonCallback = null;
            inputCallback = null;
            doubleInputCallback = null;
            dropdownInputCallback = null;

            gameObject.SetActive(false);

            tmpCallback?.Invoke(response);
            tmpInputCallback?.Invoke(response, primaryInputField.text);
            tmpDoubleInputCallback?.Invoke(response, primaryInputField.text, secondaryInputField.text);
            tmpDropdownInputCallback?.Invoke(response, optionDropdown.value, secondaryInputField.text);
        }

        /// <summary>
        /// Show the modal dialog in the indicated mode, and call the callback when it receives a response
        /// </summary>
        public static void ShowDropdownInputModal(
            string headerText,
            string primaryBodyText,
            string secondaryBodyText,
            IEnumerable<string> dropdownOptions,
            ModalDropdownInputCallback inputCallback,
            ModalButtonCallback buttonCallback = null,
            InputField.ContentType inputType = InputField.ContentType.Alphanumeric)
        {
            //Update text
            instance.SetHeaderText(headerText);
            instance.SetBodyText(primaryBodyText, secondaryBodyText);

            //Update buttons
            instance.SetMode(Mode.DropdownInput);

            //Update dropdown
            instance.optionDropdown.ClearOptions();
            instance.optionDropdown.AddOptions(dropdownOptions.ToList());
            instance.optionDropdown.value = 0;
            instance.optionDropdown.RefreshShownValue();

            //Set dialog visible
            instance.gameObject.SetActive(true);

            //Update callbacks
            instance.buttonCallback = buttonCallback;
            instance.inputCallback = null;
            instance.doubleInputCallback = null;
            instance.dropdownInputCallback = inputCallback;

            instance.secondaryInputField.contentType = inputType;
        }
    }
}